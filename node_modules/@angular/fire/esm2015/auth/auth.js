/**
 * @fileoverview added by tsickle
 * Generated from: auth.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Inject, Optional, NgZone, PLATFORM_ID, InjectionToken } from '@angular/core';
import { Observable, of, from, merge, Subject } from 'rxjs';
import { switchMap, map, observeOn, shareReplay, first, filter } from 'rxjs/operators';
import { FIREBASE_OPTIONS, FIREBASE_APP_NAME, ɵlazySDKProxy, ɵfirebaseAppFactory, ɵAngularFireSchedulers, ɵkeepUnstableUntilFirstFactory, ɵapplyMixins } from '@angular/fire';
import { isPlatformServer } from '@angular/common';
import { proxyPolyfillCompat } from './base';
import { ɵfetchInstance } from '@angular/fire';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire";
// WARNING: interface has both a type and a value, skipping emit
/** @type {?} */
import * as ɵngcc0 from '@angular/core';
export const USE_EMULATOR = new InjectionToken('angularfire2.auth.use-emulator');
/** @type {?} */
export const SETTINGS = new InjectionToken('angularfire2.auth.settings');
/** @type {?} */
export const TENANT_ID = new InjectionToken('angularfire2.auth.tenant-id');
/** @type {?} */
export const LANGUAGE_CODE = new InjectionToken('angularfire2.auth.langugage-code');
/** @type {?} */
export const USE_DEVICE_LANGUAGE = new InjectionToken('angularfire2.auth.use-device-language');
/** @type {?} */
export const PERSISTENCE = new InjectionToken('angularfire.auth.persistence');
export class AngularFireAuth {
    /**
     * @param {?} options
     * @param {?} nameOrConfig
     * @param {?} platformId
     * @param {?} zone
     * @param {?} _useEmulator
     * @param {?} _settings
     * @param {?} tenantId
     * @param {?} languageCode
     * @param {?} useDeviceLanguage
     * @param {?} persistence
     */
    constructor(options, nameOrConfig, 
    // tslint:disable-next-line:ban-types
    platformId, zone, _useEmulator, // can't use the tuple here
    _settings, // can't use firebase.auth.AuthSettings here
    tenantId, languageCode, useDeviceLanguage, persistence) {
        /** @type {?} */
        const schedulers = new ɵAngularFireSchedulers(zone);
        /** @type {?} */
        const keepUnstableUntilFirst = ɵkeepUnstableUntilFirstFactory(schedulers);
        /** @type {?} */
        const logins = new Subject();
        /** @type {?} */
        const auth = of(undefined).pipe(observeOn(schedulers.outsideAngular), switchMap((/**
         * @return {?}
         */
        () => zone.runOutsideAngular((/**
         * @return {?}
         */
        () => import('firebase/auth'))))), map((/**
         * @return {?}
         */
        () => ɵfirebaseAppFactory(options, zone, nameOrConfig))), map((/**
         * @param {?} app
         * @return {?}
         */
        app => zone.runOutsideAngular((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const useEmulator = _useEmulator;
            /** @type {?} */
            const settings = _settings;
            return ɵfetchInstance(`${app.name}.auth`, 'AngularFireAuth', app, (/**
             * @return {?}
             */
            () => {
                /** @type {?} */
                const auth = zone.runOutsideAngular((/**
                 * @return {?}
                 */
                () => app.auth()));
                if (useEmulator) {
                    // Firebase Auth doesn't conform to the useEmulator convention, let's smooth that over
                    auth.useEmulator(`http://${useEmulator.join(':')}`);
                }
                if (tenantId) {
                    auth.tenantId = tenantId;
                }
                auth.languageCode = languageCode;
                if (useDeviceLanguage) {
                    auth.useDeviceLanguage();
                }
                if (settings) {
                    auth.settings = settings;
                }
                if (persistence) {
                    auth.setPersistence(persistence);
                }
                return auth;
            }), [useEmulator, tenantId, languageCode, useDeviceLanguage, settings, persistence]);
        })))), shareReplay({ bufferSize: 1, refCount: false }));
        if (isPlatformServer(platformId)) {
            this.authState = this.user = this.idToken = this.idTokenResult = this.credential = of(null);
        }
        else {
            // HACK, as we're exporting auth.Auth, rather than auth, developers importing firebase.auth
            //       (e.g, `import { auth } from 'firebase/app'`) are getting an undefined auth object unexpectedly
            //       as we're completely lazy. Let's eagerly load the Auth SDK here.
            //       There could potentially be race conditions still... but this greatly decreases the odds while
            //       we reevaluate the API.
            /** @type {?} */
            const _ = auth.pipe(first()).subscribe();
            this.authState = auth.pipe(
            // wait for getRedirectResult otherwise we often get extraneous nulls firing on page load even if
            // a user is signed in
            switchMap((/**
             * @param {?} auth
             * @return {?}
             */
            auth => auth.getRedirectResult().then((/**
             * @return {?}
             */
            () => auth), (/**
             * @return {?}
             */
            () => auth)))), switchMap((/**
             * @param {?} auth
             * @return {?}
             */
            auth => zone.runOutsideAngular((/**
             * @return {?}
             */
            () => new Observable(auth.onAuthStateChanged.bind(auth)))))), keepUnstableUntilFirst, 
            // TODO figure out why I needed share, perhaps it's the observable construction?
            shareReplay(1));
            this.user = auth.pipe(
            // see comment on authState
            switchMap((/**
             * @param {?} auth
             * @return {?}
             */
            auth => auth.getRedirectResult().then((/**
             * @return {?}
             */
            () => auth), (/**
             * @return {?}
             */
            () => auth)))), switchMap((/**
             * @param {?} auth
             * @return {?}
             */
            auth => zone.runOutsideAngular((/**
             * @return {?}
             */
            () => new Observable(auth.onIdTokenChanged.bind(auth)))))), keepUnstableUntilFirst, shareReplay(1) // see authState
            );
            this.idToken = this.user.pipe(switchMap((/**
             * @param {?} user
             * @return {?}
             */
            user => user ? from(user.getIdToken()) : of(null))));
            this.idTokenResult = this.user.pipe(switchMap((/**
             * @param {?} user
             * @return {?}
             */
            user => user ? from(user.getIdTokenResult()) : of(null))));
            this.credential = auth.pipe(switchMap((/**
             * @param {?} auth
             * @return {?}
             */
            auth => merge(auth.getRedirectResult().then((/**
             * @param {?} it
             * @return {?}
             */
            it => it), (/**
             * @return {?}
             */
            () => null)), logins, 
            // pipe in null authState to make credential zipable, just a weird devexp if
            // authState and user go null to still have a credential
            this.authState.pipe(filter((/**
             * @param {?} it
             * @return {?}
             */
            it => !it)))))), 
            // handle the { user: { } } when a user is already logged in, rather have null
            map((/**
             * @param {?} credential
             * @return {?}
             */
            credential => (credential === null || credential === void 0 ? void 0 : credential.user) ? credential : null)), keepUnstableUntilFirst, shareReplay(1));
        }
        return ɵlazySDKProxy(this, auth, zone, { spy: {
                apply: (/**
                 * @param {?} name
                 * @param {?} _
                 * @param {?} val
                 * @return {?}
                 */
                (name, _, val) => {
                    // If they call a signIn or createUser function listen into the promise
                    // this will give us the user credential, push onto the logins Subject
                    // to be consumed in .credential
                    if (name.startsWith('signIn') || name.startsWith('createUser')) {
                        // TODO fix the types, the trouble is UserCredential has everything optional
                        val.then((/**
                         * @param {?} user
                         * @return {?}
                         */
                        (user) => logins.next((/** @type {?} */ (user)))));
                    }
                })
            } });
    }
}
AngularFireAuth.ɵfac = function AngularFireAuth_Factory(t) { return new (t || AngularFireAuth)(ɵngcc0.ɵɵinject(FIREBASE_OPTIONS), ɵngcc0.ɵɵinject(FIREBASE_APP_NAME, 8), ɵngcc0.ɵɵinject(PLATFORM_ID), ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(USE_EMULATOR, 8), ɵngcc0.ɵɵinject(SETTINGS, 8), ɵngcc0.ɵɵinject(TENANT_ID, 8), ɵngcc0.ɵɵinject(LANGUAGE_CODE, 8), ɵngcc0.ɵɵinject(USE_DEVICE_LANGUAGE, 8), ɵngcc0.ɵɵinject(PERSISTENCE, 8)); };
/** @nocollapse */
AngularFireAuth.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [FIREBASE_OPTIONS,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [FIREBASE_APP_NAME,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: NgZone },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [USE_EMULATOR,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [SETTINGS,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [TENANT_ID,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [LANGUAGE_CODE,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [USE_DEVICE_LANGUAGE,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [PERSISTENCE,] }] }
];
/** @nocollapse */ AngularFireAuth.ɵprov = i0.ɵɵdefineInjectable({ factory: function AngularFireAuth_Factory() { return new AngularFireAuth(i0.ɵɵinject(i1.FIREBASE_OPTIONS), i0.ɵɵinject(i1.FIREBASE_APP_NAME, 8), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(USE_EMULATOR, 8), i0.ɵɵinject(SETTINGS, 8), i0.ɵɵinject(TENANT_ID, 8), i0.ɵɵinject(LANGUAGE_CODE, 8), i0.ɵɵinject(USE_DEVICE_LANGUAGE, 8), i0.ɵɵinject(PERSISTENCE, 8)); }, token: AngularFireAuth, providedIn: "any" });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFireAuth, [{
        type: Injectable,
        args: [{
                providedIn: 'any'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [FIREBASE_OPTIONS]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [FIREBASE_APP_NAME]
            }] }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }, { type: ɵngcc0.NgZone }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [USE_EMULATOR]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [SETTINGS]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [TENANT_ID]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [LANGUAGE_CODE]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [USE_DEVICE_LANGUAGE]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [PERSISTENCE]
            }] }]; }, null); })();
if (false) {
    /**
     * Observable of authentication state; as of Firebase 4.0 this is only triggered via sign-in/out
     * @type {?}
     */
    AngularFireAuth.prototype.authState;
    /**
     * Observable of the currently signed-in user's JWT token used to identify the user to a Firebase service (or null).
     * @type {?}
     */
    AngularFireAuth.prototype.idToken;
    /**
     * Observable of the currently signed-in user (or null).
     * @type {?}
     */
    AngularFireAuth.prototype.user;
    /**
     * Observable of the currently signed-in user's IdTokenResult object which contains the ID token JWT string and other
     * helper properties for getting different data associated with the token as well as all the decoded payload claims
     * (or null).
     * @type {?}
     */
    AngularFireAuth.prototype.idTokenResult;
    /**
     * Observable of the currently signed-in user's credential, or null
     * @type {?}
     */
    AngularFireAuth.prototype.credential;
}
ɵapplyMixins(AngularFireAuth, [proxyPolyfillCompat]);

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vd29ya3NwYWNlL3NyYy9hdXRoL2F1dGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEcsT0FBTyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkYsT0FBTyxFQUNMLGdCQUFnQixFQUNoQixpQkFBaUIsRUFJakIsYUFBYSxFQUNiLG1CQUFtQixFQUNuQixzQkFBc0IsRUFDdEIsOEJBQThCLEVBQzlCLFlBQVksRUFDYixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDN0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMvQztBQUNvQztBQUFxQztBQUc1RDs7QUFBYixNQUFNLE9BQU8sWUFBWSxHQUFHLElBQUksY0FBYyxDQUF1QixnQ0FBZ0MsQ0FBQztBQUN0RztBQUNBLE1BQU0sT0FBTyxRQUFRLEdBQUcsSUFBSSxjQUFjLENBQTZCLDRCQUE0QixDQUFDO0FBQ3BHO0FBQUEsTUFBTSxPQUFPLFNBQVMsR0FBRyxJQUFJLGNBQWMsQ0FBUyw2QkFBNkIsQ0FBQztBQUNsRjtBQUFBLE1BQU0sT0FBTyxhQUFhLEdBQUcsSUFBSSxjQUFjLENBQVMsa0NBQWtDLENBQUM7QUFDM0Y7QUFB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Ozs7Ozs7Ozs7Ozs7a0NBVWQ7QUFBQztBQUFhO0FBQ3hDO0FBQzhCO0FBQWlCO0FBQVEsSUEvQzNELG9DQUEwRDtBQUM1RDtBQUVDO0FBQ0U7QUFDVztBQUFRLElBQXBCLGtDQUFpRDtBQUNuRDtBQUVDO0FBQ0U7QUFDVztBQUFRLElBQXBCLCtCQUFxRDtBQUN2RDtBQUVDO0FBQ0U7QUFDRTtBQUVKO0FBQWlCO0FBQVEsSUFBeEIsd0NBQTRFO0FBQzlFO0FBRUM7QUFDRTtBQUNXO0FBQVEsSUFBcEIscUNBQW9GO0FBQ3RGO0FBeUhBLFlBQVksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7QUFDckQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QsIE9wdGlvbmFsLCBOZ1pvbmUsIFBMQVRGT1JNX0lELCBJbmplY3Rpb25Ub2tlbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIGZyb20sIG1lcmdlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAsIG1hcCwgb2JzZXJ2ZU9uLCBzaGFyZVJlcGxheSwgZmlyc3QsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIEZJUkVCQVNFX09QVElPTlMsXG4gIEZJUkVCQVNFX0FQUF9OQU1FLFxuICBGaXJlYmFzZU9wdGlvbnMsXG4gIEZpcmViYXNlQXBwQ29uZmlnLFxuICDJtVByb21pc2VQcm94eSxcbiAgybVsYXp5U0RLUHJveHksXG4gIMm1ZmlyZWJhc2VBcHBGYWN0b3J5LFxuICDJtUFuZ3VsYXJGaXJlU2NoZWR1bGVycyxcbiAgybVrZWVwVW5zdGFibGVVbnRpbEZpcnN0RmFjdG9yeSxcbiAgybVhcHBseU1peGluc1xufSBmcm9tICdAYW5ndWxhci9maXJlJztcbmltcG9ydCBmaXJlYmFzZSBmcm9tICdmaXJlYmFzZS9hcHAnO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybVNlcnZlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBwcm94eVBvbHlmaWxsQ29tcGF0IH0gZnJvbSAnLi9iYXNlJztcbmltcG9ydCB7IMm1ZmV0Y2hJbnN0YW5jZSB9IGZyb20gJ0Bhbmd1bGFyL2ZpcmUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFuZ3VsYXJGaXJlQXV0aCBleHRlbmRzIMm1UHJvbWlzZVByb3h5PGZpcmViYXNlLmF1dGguQXV0aD4ge31cblxudHlwZSBVc2VFbXVsYXRvckFyZ3VtZW50cyA9IFtzdHJpbmcsIG51bWJlcl07XG5leHBvcnQgY29uc3QgVVNFX0VNVUxBVE9SID0gbmV3IEluamVjdGlvblRva2VuPFVzZUVtdWxhdG9yQXJndW1lbnRzPignYW5ndWxhcmZpcmUyLmF1dGgudXNlLWVtdWxhdG9yJyk7XG5cbmV4cG9ydCBjb25zdCBTRVRUSU5HUyA9IG5ldyBJbmplY3Rpb25Ub2tlbjxmaXJlYmFzZS5hdXRoLkF1dGhTZXR0aW5ncz4oJ2FuZ3VsYXJmaXJlMi5hdXRoLnNldHRpbmdzJyk7XG5leHBvcnQgY29uc3QgVEVOQU5UX0lEID0gbmV3IEluamVjdGlvblRva2VuPHN0cmluZz4oJ2FuZ3VsYXJmaXJlMi5hdXRoLnRlbmFudC1pZCcpO1xuZXhwb3J0IGNvbnN0IExBTkdVQUdFX0NPREUgPSBuZXcgSW5qZWN0aW9uVG9rZW48c3RyaW5nPignYW5ndWxhcmZpcmUyLmF1dGgubGFuZ3VnYWdlLWNvZGUnKTtcbmV4cG9ydCBjb25zdCBVU0VfREVWSUNFX0xBTkdVQUdFID0gbmV3IEluamVjdGlvblRva2VuPGJvb2xlYW4+KCdhbmd1bGFyZmlyZTIuYXV0aC51c2UtZGV2aWNlLWxhbmd1YWdlJyk7XG5leHBvcnQgY29uc3QgUEVSU0lTVEVOQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48c3RyaW5nPignYW5ndWxhcmZpcmUuYXV0aC5wZXJzaXN0ZW5jZScpO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdhbnknXG59KVxuZXhwb3J0IGNsYXNzIEFuZ3VsYXJGaXJlQXV0aCB7XG5cbiAgLyoqXG4gICAqIE9ic2VydmFibGUgb2YgYXV0aGVudGljYXRpb24gc3RhdGU7IGFzIG9mIEZpcmViYXNlIDQuMCB0aGlzIGlzIG9ubHkgdHJpZ2dlcmVkIHZpYSBzaWduLWluL291dFxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGF1dGhTdGF0ZTogT2JzZXJ2YWJsZTxmaXJlYmFzZS5Vc2VyfG51bGw+O1xuXG4gIC8qKlxuICAgKiBPYnNlcnZhYmxlIG9mIHRoZSBjdXJyZW50bHkgc2lnbmVkLWluIHVzZXIncyBKV1QgdG9rZW4gdXNlZCB0byBpZGVudGlmeSB0aGUgdXNlciB0byBhIEZpcmViYXNlIHNlcnZpY2UgKG9yIG51bGwpLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGlkVG9rZW46IE9ic2VydmFibGU8c3RyaW5nfG51bGw+O1xuXG4gIC8qKlxuICAgKiBPYnNlcnZhYmxlIG9mIHRoZSBjdXJyZW50bHkgc2lnbmVkLWluIHVzZXIgKG9yIG51bGwpLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHVzZXI6IE9ic2VydmFibGU8ZmlyZWJhc2UuVXNlcnxudWxsPjtcblxuICAvKipcbiAgICogT2JzZXJ2YWJsZSBvZiB0aGUgY3VycmVudGx5IHNpZ25lZC1pbiB1c2VyJ3MgSWRUb2tlblJlc3VsdCBvYmplY3Qgd2hpY2ggY29udGFpbnMgdGhlIElEIHRva2VuIEpXVCBzdHJpbmcgYW5kIG90aGVyXG4gICAqIGhlbHBlciBwcm9wZXJ0aWVzIGZvciBnZXR0aW5nIGRpZmZlcmVudCBkYXRhIGFzc29jaWF0ZWQgd2l0aCB0aGUgdG9rZW4gYXMgd2VsbCBhcyBhbGwgdGhlIGRlY29kZWQgcGF5bG9hZCBjbGFpbXNcbiAgICogKG9yIG51bGwpLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGlkVG9rZW5SZXN1bHQ6IE9ic2VydmFibGU8ZmlyZWJhc2UuYXV0aC5JZFRva2VuUmVzdWx0fG51bGw+O1xuXG4gIC8qKlxuICAgKiBPYnNlcnZhYmxlIG9mIHRoZSBjdXJyZW50bHkgc2lnbmVkLWluIHVzZXIncyBjcmVkZW50aWFsLCBvciBudWxsXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgY3JlZGVudGlhbDogT2JzZXJ2YWJsZTxSZXF1aXJlZDxmaXJlYmFzZS5hdXRoLlVzZXJDcmVkZW50aWFsPnxudWxsPjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KEZJUkVCQVNFX09QVElPTlMpIG9wdGlvbnM6IEZpcmViYXNlT3B0aW9ucyxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEZJUkVCQVNFX0FQUF9OQU1FKSBuYW1lT3JDb25maWc6IHN0cmluZ3xGaXJlYmFzZUFwcENvbmZpZ3xudWxsfHVuZGVmaW5lZCxcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6YmFuLXR5cGVzXG4gICAgQEluamVjdChQTEFURk9STV9JRCkgcGxhdGZvcm1JZDogT2JqZWN0LFxuICAgIHpvbmU6IE5nWm9uZSxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFVTRV9FTVVMQVRPUikgX3VzZUVtdWxhdG9yOiBhbnksIC8vIGNhbid0IHVzZSB0aGUgdHVwbGUgaGVyZVxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoU0VUVElOR1MpIF9zZXR0aW5nczogYW55LCAvLyBjYW4ndCB1c2UgZmlyZWJhc2UuYXV0aC5BdXRoU2V0dGluZ3MgaGVyZVxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoVEVOQU5UX0lEKSB0ZW5hbnRJZDogc3RyaW5nIHwgbnVsbCxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KExBTkdVQUdFX0NPREUpIGxhbmd1YWdlQ29kZTogc3RyaW5nIHwgbnVsbCxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFVTRV9ERVZJQ0VfTEFOR1VBR0UpIHVzZURldmljZUxhbmd1YWdlOiBib29sZWFuIHwgbnVsbCxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFBFUlNJU1RFTkNFKSBwZXJzaXN0ZW5jZTogc3RyaW5nIHwgbnVsbCxcbiAgKSB7XG4gICAgY29uc3Qgc2NoZWR1bGVycyA9IG5ldyDJtUFuZ3VsYXJGaXJlU2NoZWR1bGVycyh6b25lKTtcbiAgICBjb25zdCBrZWVwVW5zdGFibGVVbnRpbEZpcnN0ID0gybVrZWVwVW5zdGFibGVVbnRpbEZpcnN0RmFjdG9yeShzY2hlZHVsZXJzKTtcbiAgICBjb25zdCBsb2dpbnMgPSBuZXcgU3ViamVjdDxSZXF1aXJlZDxmaXJlYmFzZS5hdXRoLlVzZXJDcmVkZW50aWFsPj4oKTtcblxuICAgIGNvbnN0IGF1dGggPSBvZih1bmRlZmluZWQpLnBpcGUoXG4gICAgICBvYnNlcnZlT24oc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhciksXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiBpbXBvcnQoJ2ZpcmViYXNlL2F1dGgnKSkpLFxuICAgICAgbWFwKCgpID0+IMm1ZmlyZWJhc2VBcHBGYWN0b3J5KG9wdGlvbnMsIHpvbmUsIG5hbWVPckNvbmZpZykpLFxuICAgICAgbWFwKGFwcCA9PiB6b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgY29uc3QgdXNlRW11bGF0b3I6IFVzZUVtdWxhdG9yQXJndW1lbnRzIHwgbnVsbCA9IF91c2VFbXVsYXRvcjtcbiAgICAgICAgY29uc3Qgc2V0dGluZ3M6IGZpcmViYXNlLmF1dGguQXV0aFNldHRpbmdzIHwgbnVsbCA9IF9zZXR0aW5ncztcbiAgICAgICAgcmV0dXJuIMm1ZmV0Y2hJbnN0YW5jZShgJHthcHAubmFtZX0uYXV0aGAsICdBbmd1bGFyRmlyZUF1dGgnLCBhcHAsICgpID0+IHtcbiAgICAgICAgICBjb25zdCBhdXRoID0gem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiBhcHAuYXV0aCgpKTtcbiAgICAgICAgICBpZiAodXNlRW11bGF0b3IpIHtcbiAgICAgICAgICAgIC8vIEZpcmViYXNlIEF1dGggZG9lc24ndCBjb25mb3JtIHRvIHRoZSB1c2VFbXVsYXRvciBjb252ZW50aW9uLCBsZXQncyBzbW9vdGggdGhhdCBvdmVyXG4gICAgICAgICAgICBhdXRoLnVzZUVtdWxhdG9yKGBodHRwOi8vJHt1c2VFbXVsYXRvci5qb2luKCc6Jyl9YCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0ZW5hbnRJZCkge1xuICAgICAgICAgICAgYXV0aC50ZW5hbnRJZCA9IHRlbmFudElkO1xuICAgICAgICAgIH1cbiAgICAgICAgICBhdXRoLmxhbmd1YWdlQ29kZSA9IGxhbmd1YWdlQ29kZTtcbiAgICAgICAgICBpZiAodXNlRGV2aWNlTGFuZ3VhZ2UpIHtcbiAgICAgICAgICAgIGF1dGgudXNlRGV2aWNlTGFuZ3VhZ2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHNldHRpbmdzKSB7XG4gICAgICAgICAgICBhdXRoLnNldHRpbmdzID0gc2V0dGluZ3M7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwZXJzaXN0ZW5jZSkge1xuICAgICAgICAgICAgYXV0aC5zZXRQZXJzaXN0ZW5jZShwZXJzaXN0ZW5jZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBhdXRoO1xuICAgICAgICB9LCBbdXNlRW11bGF0b3IsIHRlbmFudElkLCBsYW5ndWFnZUNvZGUsIHVzZURldmljZUxhbmd1YWdlLCBzZXR0aW5ncywgcGVyc2lzdGVuY2VdKTtcbiAgICAgIH0pKSxcbiAgICAgIHNoYXJlUmVwbGF5KHsgYnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IGZhbHNlIH0pLFxuICAgICk7XG5cbiAgICBpZiAoaXNQbGF0Zm9ybVNlcnZlcihwbGF0Zm9ybUlkKSkge1xuXG4gICAgICB0aGlzLmF1dGhTdGF0ZSA9IHRoaXMudXNlciA9IHRoaXMuaWRUb2tlbiA9IHRoaXMuaWRUb2tlblJlc3VsdCA9IHRoaXMuY3JlZGVudGlhbCA9IG9mKG51bGwpO1xuXG4gICAgfSBlbHNlIHtcblxuICAgICAgLy8gSEFDSywgYXMgd2UncmUgZXhwb3J0aW5nIGF1dGguQXV0aCwgcmF0aGVyIHRoYW4gYXV0aCwgZGV2ZWxvcGVycyBpbXBvcnRpbmcgZmlyZWJhc2UuYXV0aFxuICAgICAgLy8gICAgICAgKGUuZywgYGltcG9ydCB7IGF1dGggfSBmcm9tICdmaXJlYmFzZS9hcHAnYCkgYXJlIGdldHRpbmcgYW4gdW5kZWZpbmVkIGF1dGggb2JqZWN0IHVuZXhwZWN0ZWRseVxuICAgICAgLy8gICAgICAgYXMgd2UncmUgY29tcGxldGVseSBsYXp5LiBMZXQncyBlYWdlcmx5IGxvYWQgdGhlIEF1dGggU0RLIGhlcmUuXG4gICAgICAvLyAgICAgICBUaGVyZSBjb3VsZCBwb3RlbnRpYWxseSBiZSByYWNlIGNvbmRpdGlvbnMgc3RpbGwuLi4gYnV0IHRoaXMgZ3JlYXRseSBkZWNyZWFzZXMgdGhlIG9kZHMgd2hpbGVcbiAgICAgIC8vICAgICAgIHdlIHJlZXZhbHVhdGUgdGhlIEFQSS5cbiAgICAgIGNvbnN0IF8gPSBhdXRoLnBpcGUoZmlyc3QoKSkuc3Vic2NyaWJlKCk7XG5cbiAgICAgIHRoaXMuYXV0aFN0YXRlID0gYXV0aC5waXBlKFxuICAgICAgICAvLyB3YWl0IGZvciBnZXRSZWRpcmVjdFJlc3VsdCBvdGhlcndpc2Ugd2Ugb2Z0ZW4gZ2V0IGV4dHJhbmVvdXMgbnVsbHMgZmlyaW5nIG9uIHBhZ2UgbG9hZCBldmVuIGlmXG4gICAgICAgIC8vIGEgdXNlciBpcyBzaWduZWQgaW5cbiAgICAgICAgc3dpdGNoTWFwKGF1dGggPT4gYXV0aC5nZXRSZWRpcmVjdFJlc3VsdCgpLnRoZW4oKCkgPT4gYXV0aCwgKCkgPT4gYXV0aCkpLFxuICAgICAgICBzd2l0Y2hNYXAoYXV0aCA9PiB6b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IG5ldyBPYnNlcnZhYmxlPGZpcmViYXNlLlVzZXJ8bnVsbD4oYXV0aC5vbkF1dGhTdGF0ZUNoYW5nZWQuYmluZChhdXRoKSkpKSxcbiAgICAgICAga2VlcFVuc3RhYmxlVW50aWxGaXJzdCxcbiAgICAgICAgLy8gVE9ETyBmaWd1cmUgb3V0IHdoeSBJIG5lZWRlZCBzaGFyZSwgcGVyaGFwcyBpdCdzIHRoZSBvYnNlcnZhYmxlIGNvbnN0cnVjdGlvbj9cbiAgICAgICAgc2hhcmVSZXBsYXkoMSlcbiAgICAgICk7XG5cbiAgICAgIHRoaXMudXNlciA9IGF1dGgucGlwZShcbiAgICAgICAgLy8gc2VlIGNvbW1lbnQgb24gYXV0aFN0YXRlXG4gICAgICAgIHN3aXRjaE1hcChhdXRoID0+IGF1dGguZ2V0UmVkaXJlY3RSZXN1bHQoKS50aGVuKCgpID0+IGF1dGgsICgpID0+IGF1dGgpKSxcbiAgICAgICAgc3dpdGNoTWFwKGF1dGggPT4gem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiBuZXcgT2JzZXJ2YWJsZTxmaXJlYmFzZS5Vc2VyfG51bGw+KGF1dGgub25JZFRva2VuQ2hhbmdlZC5iaW5kKGF1dGgpKSkpLFxuICAgICAgICBrZWVwVW5zdGFibGVVbnRpbEZpcnN0LFxuICAgICAgICBzaGFyZVJlcGxheSgxKSAvLyBzZWUgYXV0aFN0YXRlXG4gICAgICApO1xuXG4gICAgICB0aGlzLmlkVG9rZW4gPSB0aGlzLnVzZXIucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKHVzZXIgPT4gdXNlciA/IGZyb20odXNlci5nZXRJZFRva2VuKCkpIDogb2YobnVsbCkpXG4gICAgICApO1xuXG4gICAgICB0aGlzLmlkVG9rZW5SZXN1bHQgPSB0aGlzLnVzZXIucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKHVzZXIgPT4gdXNlciA/IGZyb20odXNlci5nZXRJZFRva2VuUmVzdWx0KCkpIDogb2YobnVsbCkpXG4gICAgICApO1xuXG4gICAgICB0aGlzLmNyZWRlbnRpYWwgPSBhdXRoLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcChhdXRoID0+IG1lcmdlKFxuICAgICAgICAgIGF1dGguZ2V0UmVkaXJlY3RSZXN1bHQoKS50aGVuKGl0ID0+IGl0LCAoKSA9PiBudWxsKSxcbiAgICAgICAgICBsb2dpbnMsXG4gICAgICAgICAgLy8gcGlwZSBpbiBudWxsIGF1dGhTdGF0ZSB0byBtYWtlIGNyZWRlbnRpYWwgemlwYWJsZSwganVzdCBhIHdlaXJkIGRldmV4cCBpZlxuICAgICAgICAgIC8vIGF1dGhTdGF0ZSBhbmQgdXNlciBnbyBudWxsIHRvIHN0aWxsIGhhdmUgYSBjcmVkZW50aWFsXG4gICAgICAgICAgdGhpcy5hdXRoU3RhdGUucGlwZShmaWx0ZXIoaXQgPT4gIWl0KSlcbiAgICAgICAgKSksXG4gICAgICAgIC8vIGhhbmRsZSB0aGUgeyB1c2VyOiB7IH0gfSB3aGVuIGEgdXNlciBpcyBhbHJlYWR5IGxvZ2dlZCBpbiwgcmF0aGVyIGhhdmUgbnVsbFxuICAgICAgICBtYXAoY3JlZGVudGlhbCA9PiBjcmVkZW50aWFsPy51c2VyID8gY3JlZGVudGlhbCA6IG51bGwpLFxuICAgICAgICBrZWVwVW5zdGFibGVVbnRpbEZpcnN0LFxuICAgICAgICBzaGFyZVJlcGxheSgxKVxuICAgICAgKTtcblxuICAgIH1cblxuICAgIHJldHVybiDJtWxhenlTREtQcm94eSh0aGlzLCBhdXRoLCB6b25lLCB7IHNweToge1xuICAgICAgYXBwbHk6IChuYW1lLCBfLCB2YWwpID0+IHtcbiAgICAgICAgLy8gSWYgdGhleSBjYWxsIGEgc2lnbkluIG9yIGNyZWF0ZVVzZXIgZnVuY3Rpb24gbGlzdGVuIGludG8gdGhlIHByb21pc2VcbiAgICAgICAgLy8gdGhpcyB3aWxsIGdpdmUgdXMgdGhlIHVzZXIgY3JlZGVudGlhbCwgcHVzaCBvbnRvIHRoZSBsb2dpbnMgU3ViamVjdFxuICAgICAgICAvLyB0byBiZSBjb25zdW1lZCBpbiAuY3JlZGVudGlhbFxuICAgICAgICBpZiAobmFtZS5zdGFydHNXaXRoKCdzaWduSW4nKSB8fCBuYW1lLnN0YXJ0c1dpdGgoJ2NyZWF0ZVVzZXInKSkge1xuICAgICAgICAgIC8vIFRPRE8gZml4IHRoZSB0eXBlcywgdGhlIHRyb3VibGUgaXMgVXNlckNyZWRlbnRpYWwgaGFzIGV2ZXJ5dGhpbmcgb3B0aW9uYWxcbiAgICAgICAgICB2YWwudGhlbigodXNlcjogZmlyZWJhc2UuYXV0aC5Vc2VyQ3JlZGVudGlhbCkgPT4gbG9naW5zLm5leHQodXNlciBhcyBhbnkpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH19KTtcblxuICB9XG5cbn1cblxuybVhcHBseU1peGlucyhBbmd1bGFyRmlyZUF1dGgsIFtwcm94eVBvbHlmaWxsQ29tcGF0XSk7XG4iXX0=